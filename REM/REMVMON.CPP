/*---------------------------------------------------------------------+\|																		||				copyright 1986 .. 1997 Grizzly Software					||					a division of Bear Consulting Group					||																		||	This software-file/document, in whole or in part, including			||	the structures and the procedures described herein, may not			||	be provided or otherwise made available without prior written		||	authorization.  In case of authorized or unauthorized				||	publication or duplication, copyright is claimed.					||																		|\+---------------------------------------------------------------------*//*---------------------------------------------------------------------+\||	remvmon.cpp  --  view class for monthly messages||	Purpose:|	Author and Date:	J.Griswold			11-Mar-1995|\+---------------------------------------------------------------------*//*---------------------------------------------------------------------+\||	Revision History:|	25-Mar-1997			J.Griswold		Change cmdSetDate so that it only updates the members if the		new values would require them to change.	23-Feb-1997			J.Griswold		Correctly handle having no messages	11-Mar-1995			J.Griswold		Initial Revision|\+---------------------------------------------------------------------*//*---------------------------------------------------------------------+\|																		||	Include Files														||																		|\+---------------------------------------------------------------------*/#include "stdafx.h"		// must be first include for MFC#include <string.h>#include <ctype.h>#include "beardefs.h"#include "strform.h"#include "ztextsrv.h"#include "remvmon.h"#include "remdoc.h"#include "remappl.h"#include "datevalu.h"#include "dkeyword.h"/*---------------------------------------------------------------------+\|																		||	Local defines / constants											||																		|\+---------------------------------------------------------------------*/#define INHERITED	RemindViewBase/*---------------------------------------------------------------------+\|																		||	Local type definitions												||																		|\+---------------------------------------------------------------------*//*---------------------------------------------------------------------+\|																		||	Private Global variables											||																		|\+---------------------------------------------------------------------*//*---------------------------------------------------------------------+\|																		||	Public Global variables												||																		|\+---------------------------------------------------------------------*//*---------------------------------------------------------------------+\|																		||	External variables													||																		|\+---------------------------------------------------------------------*//*=====================================================================+\||																		|||	 Code																|||																		|\+=====================================================================*/#if 0#pragma mark ____MonthlyDrawDate____#endifvoid	MonthlyDrawJDay::displayDate		(		XPDrawPtr	pDraw,		Pixel		x,		Pixel		y,		NodeJDayPtr	pList		){	int			nHeight;	int			nLabelHeight;	int			nLabelAscent;	NodeJDayPtr	pItem;	Long		nJulian;	URect		r;	TextRangeInfo	tRange;	ZTextServerPtr	pTextServer;	XPColor		black( 0, 0, 0 );	char		sDate[20];	char		sWeekday[20];		UNREFERENCED_PARAMETER( x );		pTextServer = ZTextServer::getTextServer();	pDraw->getUpdateRect( &r );	nLabelHeight = vpLabelStyle->getHeight();	nLabelAscent = vpLabelStyle->getAscent();		for ( pItem = pList; pItem; pItem = (NodeJDayPtr)pItem->getNext() )	{		if ( r.bottom < y )			break;				pItem->getDisplaySize( &tRange );		nHeight = tRange.rect.bottom - tRange.rect.top;				if ( r.top				< (y + ((nHeight < nLabelHeight) ? nLabelHeight : nHeight))				)		{			nJulian = pItem->getJulianDay();			strDate_weekdayFromJulian( sWeekday, nJulian );	    	strDate_ddmmmyyyyFromJulian( sDate, nJulian );	    	pTextServer->displayString( pDraw,	    							vnDayName, y,	    							vpLabelStyle,	    							sWeekday, 0, TEXTJUST_TopLeft );	    	pTextServer->displayString( pDraw,	    							vnDate, y,	    							vpLabelStyle,	    							sDate, 2, TEXTJUST_TopLeft );    	}		if ( nHeight < nLabelHeight )		{			pItem->drawAt( pDraw, vnMessage, y + nLabelAscent - tRange.nAscender );			y += nLabelHeight;		}		else		{			pItem->drawAt( pDraw, vnMessage, y );			y += nHeight;		}	}}void	MonthlyDrawJDay::gatherRange		(		UPointPtr	pSize,		NodeJDayPtr	pList		){	pList->getDisplayExtents( pSize );	pSize->x += vnMessage;	if ( pSize->y < vpLabelStyle->getHeight() )		pSize->y = vpLabelStyle->getHeight();}#if 0#pragma mark ____MonthlyDrawWeek____#endifvoid	MonthlyDrawWeek::displayJDayList		(		XPDrawPtr	pDraw,		Pixel		x,		Pixel		y,		NodeJDayOwnerPtr	pList		){	NodeJDayPtr	pItem;	NodeJDayPtr	pNext;	UPoint		range;	URect		r;	URect		rBox;		pDraw->getUpdateRect( &r );		rBox.top = y + 1;	rBox.left = r.left;	rBox.right = r.right;	y += VIEW_MARGIN_TOP;		pItem = pList->getJDayList();	while ( pItem )	{		if ( r.bottom < y )			break;		pNext = (NodeJDayPtr)pItem->getNext();		vpDrawJDay->gatherRange( &range, pItem );		rBox.bottom = y + range.y;		if ( r.top <= rBox.bottom )		{			if ( vbBox )			{				if ( NULL == pNext )					rBox.bottom += VIEW_MARGIN_TOP;				pDraw->setForeColor( XPColor( COLOR_Gray_5 ) );				pDraw->drawFillRect( &rBox );			}			vpDrawJDay->displayDate( pDraw, x, y, pItem );		}		y += range.y;		rBox.top = y;		vbBox = !vbBox;		pItem = pNext;	}	if ( pList->getNext() )	{		XPColor	black( 0, 0, 0 );				y += VIEW_MARGIN_TOP;		pDraw->setWidth( 1 );		pDraw->setForeColor( black );		pDraw->drawMoveTo( 0, y );		pDraw->drawLineTo( r.right, y );	}}void	MonthlyDrawWeek::gatherRange		(		UPointPtr			pSize,		NodeJDayOwnerPtr	pList		){	NodeJDayPtr		pItem;	UPoint			range;		pSize->x = 0;	pSize->y = 0;		pItem = pList->getJDayList();	while ( pItem )	{		vpDrawJDay->gatherRange( &range, pItem );		if ( pSize->x < range.x )			pSize->x = range.x;		pSize->y += range.y;		pItem = (NodeJDayPtr)pItem->getNext();	}	pSize->y += VIEW_MARGIN_TOP * 2;}#if 0#pragma mark ____class____#endifIMPL_StreamCreate( RemindViewMonthly, INHERITED )#if 0{}#endif/*---------------------------------------------------------------------+\ *  NAME:	 initRemindViewMonthly - constructor *  DESCRIPTION: *  AUTHOR: J.Griswold			DATE:	13-Feb-1995\+---------------------------------------------------------------------*/void	RemindViewMonthly::initRemindViewMonthly		(		void		){	vnYear = 0;	vnMonth = 0;	vpNodeWeek = NULL;}/*---------------------------------------------------------------------+\ *  NAME:	 RemindViewMonthly - constructor *  DESCRIPTION: *  AUTHOR: J.Griswold			DATE:	13-Feb-1995\+---------------------------------------------------------------------*/RemindViewMonthly::RemindViewMonthly		(		void		){	initRemindViewMonthly();}/*---------------------------------------------------------------------+\ *  NAME:	 ~RemindViewMonthly - destructor *  DESCRIPTION: *  AUTHOR: J.Griswold			DATE:	13-Feb-1995\+---------------------------------------------------------------------*/RemindViewMonthly::~RemindViewMonthly		(		void		){	if ( vpNodeWeek )		vpNodeWeek->destroyAllLinks();	vpNodeWeek = NULL;	if ( vDrawJDay.vpLabelStyle )		vDrawJDay.vpLabelStyle->release();}/*=====================================================================+\||	 public member functions											|\+=====================================================================*/#if 0#pragma mark ____public____#endif/*=====================================================================+\||	 protected member functions											|\+=====================================================================*/#if 0#pragma mark ____protected____#endif/*---------------------------------------------------------------------+\ *  NAME:	 gatherDisplayExtents - brief statement *  DESCRIPTION: *  AUTHOR: J.Griswold			DATE:	08-May-1995\+---------------------------------------------------------------------*/void	RemindViewMonthly::gatherDisplayExtents		(		UPointPtr	pExtents		){	NodeWeekPtr		pItem;	UPoint			range;		pExtents->x = 0;	pExtents->y = 0;	range.x = range.y = 0;	pItem = vpNodeWeek;	while ( pItem )	{		vDrawWeek.gatherRange( &range, pItem );		if ( pExtents->x < range.x )			pExtents->x = range.x;		pExtents->y += range.y;		pItem = (NodeWeekPtr)pItem->getNext();	}	pExtents->x += VIEW_MARGIN_LEFT;}/*=====================================================================+\||	 private member functions											|\+=====================================================================*/#if 0#pragma mark ____private____#endif/*=====================================================================+\||																		|||	 Overrides															|||																		|\+=====================================================================*/#if 0#pragma mark ________Overrides________#endif/*---------------------------------------------------------------------+\ *  NAME:	 documentInitialAttachment - brief statement *  DESCRIPTION: *  AUTHOR: J.Griswold			DATE:	24-Apr-1995\+---------------------------------------------------------------------*/void	RemindViewMonthly::documentInitialAttachment		(		void		){	Long	nToday;	int		dd;	int		mm;	int		yy;		INHERITED::documentInitialAttachment();	nToday = dateValue_today();	julianDate_gregorianFromNumber( &dd, &mm, &yy, nToday );	vnYear = yy;	vnMonth = mm;		vDrawWeek.vpDrawJDay = &vDrawJDay;	vDrawJDay.vpLabelStyle = ((RemindApplication*)XPApplication::getApplicationPtr())->getStyleDefaultLabel();	if ( vDrawJDay.vpLabelStyle )	{		XPFontPtr	pFontServer;				vDrawJDay.vpLabelStyle->addRef();				pFontServer = XPFont::getFontServer();		vDrawJDay.vpLabelStyle->activateStyle( pFontServer );		vDrawJDay.vnDayName = VIEW_MARGIN_LEFT;		vDrawJDay.vnDate = vDrawJDay.vnDayName + pFontServer->getStringWidth( "Wednesday  " );		vDrawJDay.vnMessage = vDrawJDay.vnDate + pFontServer->getStringWidth( "99   " );		vDrawJDay.vnLine = vDrawJDay.vnMessage - pFontServer->getStringWidth( "   " ) / 2;	}	gatherDates();}#if 0#pragma mark ____RemindViewBase____#endifvoid	RemindViewMonthly::cmdSetDate		(		Long	nJulian		){	int		dd;	int		mm;	int		yy;		julianDate_gregorianFromNumber( &dd, &mm, &yy, nJulian );	if ( yy != vnYear  ||  mm != vnMonth )	{		vnYear = yy;		vnMonth = mm;		gatherDates();		imageSetOrigin( 0, 0 );		viewRefresh();	}}void	RemindViewMonthly::calcCalendarHilite		(		void		){	Long	nEarly;	Long	nLate;		nEarly = julianDate_numberFromGregorian( 1, vnMonth, vnYear );	nLate = julianDate_numberFromGregorian( -1, vnMonth, vnYear );		requestCalendarHilite( nEarly, nLate );}/*---------------------------------------------------------------------+\ *  NAME:	 buildViewHeader - brief statement *  DESCRIPTION: *  AUTHOR: J.Griswold			DATE:	15-May-1995\+---------------------------------------------------------------------*/void	RemindViewMonthly::buildViewHeader		(		void		){	Char	sTitle[80];	CharPtr	p;		p = sTitle;	::strcpy( p, "Reminders for the Month -- " );	p += ::strlen( p );	::strcpy( p, dkeyword_strMonth( vnMonth ) );	*p = toupper( *p );	p += ::strlen( p );	::strcpy( p, ", " );	p += 2;	::strFormat_decimal( p, vnYear );	p += 4;	setCaption( sTitle );}/*---------------------------------------------------------------------+\ *  NAME:	getViewCmd - brief statement *  DESCRIPTION: *  AUTHOR: J.Griswold			DATE:	01-Jan-1996\+---------------------------------------------------------------------*/long	RemindViewMonthly::getViewCmd		(		void		){	return CMD_NewMonthly;}/*---------------------------------------------------------------------+\ *  NAME:	 dateNext - brief statement *  DESCRIPTION: *  AUTHOR: J.Griswold			DATE:	20-Jun-1995\+---------------------------------------------------------------------*/void	RemindViewMonthly::dateNext		(		void		){	++vnMonth;	if ( vnMonth > 12 )	{		vnMonth = 1;		++vnYear;	}}/*---------------------------------------------------------------------+\ *  NAME:	 datePrevious - brief statement *  DESCRIPTION: *  AUTHOR: J.Griswold			DATE:	20-Jun-1995\+---------------------------------------------------------------------*/void	RemindViewMonthly::datePrevious		(		void		){	--vnMonth;	if ( vnMonth < 1 )	{		vnMonth = 12;		--vnYear;	}}/*---------------------------------------------------------------------+\ *  NAME:	 dateBlockNext - brief statement *  DESCRIPTION: *  AUTHOR: J.Griswold			DATE:	14-Jan-1996\+---------------------------------------------------------------------*/void	RemindViewMonthly::dateBlockNext		(		void		){	++vnYear;}/*---------------------------------------------------------------------+\ *  NAME:	 dateBlockPrevious - brief statement *  DESCRIPTION: *  AUTHOR: J.Griswold			DATE:	14-Jan-1996\+---------------------------------------------------------------------*/void	RemindViewMonthly::dateBlockPrevious		(		void		){	--vnYear;}/*---------------------------------------------------------------------+\ *  NAME:	 gatherDates - brief statement *  DESCRIPTION: *  AUTHOR: J.Griswold			DATE:	08-May-1995\+---------------------------------------------------------------------*/Bool	RemindViewMonthly::gatherDates		(		void		){	Bool				result = NO;	RemindDocumentPtr	pDoc;	Long				nEarly;	Long				nLate;	NodeJDayPtr			pNodeJDay;	buildViewHeader();	pDoc = (RemindDocumentPtr)documentFetch();	if ( pDoc )	{		if ( vpNodeWeek )			vpNodeWeek->destroyAllLinks();				nEarly = julianDate_numberFromGregorian( 1, vnMonth, vnYear );		nLate = julianDate_numberFromGregorian( -1, vnMonth, vnYear );				pNodeJDay = pDoc->getRange( nEarly, nLate );		if ( pNodeJDay )		{			UPoint	pt;						vpNodeWeek = NodeWeek::buildWeekList( pNodeJDay );			result = YES;			gatherDisplayExtents( &pt );			imageSetSize( pt.x, pt.y );		}		else		{			vpNodeWeek = NULL;			imageSetOrigin( 0, 0 );			imageSetSize( 5, 5 );		}		calcCalendarHilite();	}	return result;}/*---------------------------------------------------------------------+\ *  NAME:	 displayJDays - brief statement *  DESCRIPTION: *  AUTHOR: J.Griswold			DATE:	08-May-1995\+---------------------------------------------------------------------*/void	RemindViewMonthly::displayJDays		(		XPDrawPtr	pDraw,		URectPtr	pUpdateRect		){	NodeWeekPtr		pItem;	Long			x, y;	UPoint			range;		vDrawWeek.vbBox = NO;	pItem = vpNodeWeek;		x = 4;	y = 0;	while ( pItem )	{		if ( pUpdateRect->bottom < y )			break;		vDrawWeek.gatherRange( &range, pItem );		if ( pUpdateRect->top <= y + range.y )		{			vDrawWeek.displayJDayList( pDraw, x, y, pItem );		}		else		{			int		nCount = pItem->getJDayCount();						if ( 0 != nCount % 2 )				vDrawWeek.vbBox = ! vDrawWeek.vbBox;		}		y += range.y;		pItem = (NodeWeekPtr)pItem->getNext();	}	pDraw->setForeColor( XPColor( COLOR_Black ) );	pDraw->drawMoveTo( vDrawJDay.vnLine, pUpdateRect->top-1 );	pDraw->drawLineTo( vDrawJDay.vnLine, pUpdateRect->bottom+1 );}/*---------------------------------------------------------------------+\ *  NAME:	 somePackage_someFunction - brief statement *  DESCRIPTION: *  AUTHOR: J.Griswold			DATE:	dd-mmm-1995\+---------------------------------------------------------------------*/